{% extends "base.html" %} {% block content %}
<div class="card shadow-sm mb-4">
  <div class="card-header d-flex align-items-center justify-content-between">
    <h2 class="card-title mb-0 fs-4 d-flex align-items-center">
      <i class="bi bi-people-fill me-2"></i> All Users
    </h2>
    <div>
      <a
        href="{% url 'add_user' %}"
        class="btn btn-sm btn-success d-flex align-items-center me-2"
      >
        <i class="bi bi-person-plus me-1"></i> Add New User
      </a>
      <button
        id="bulkDeleteBtn"
        class="btn btn-sm btn-danger d-flex align-items-center"
      >
        <i class="bi bi-trash me-1"></i> Delete Selected
      </button>
    </div>
  </div>

  <div class="card-body table-responsive">
    <table
      class="table table-striped table-bordered align-middle"
      id="userTable"
    >
      <thead class="bg-light">
        <tr>
          <th>
            <input type="checkbox" id="selectAll" class="form-check-input" />
          </th>
          <th>Sno</th>
          <th>Username</th>
          <th>First Name</th>
          <th>Email</th>
          <th>Role</th>
          <th class="text-center">Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="noUserMessage" class="text-center py-5 my-4 d-none">
      <h5 class="fw-bold text-secondary mb-2">
        <i class="fa-solid fa-user-slash text-danger me-2"></i>No Users Found
      </h5>
      <p class="text-muted mb-3">You haven't added any users yet!</p>
      <a href="{% url 'add_user' %}" class="btn btn-success shadow-sm">
        <i class="fa-solid fa-user-plus me-1"></i> Add New User
      </a>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  $(document).ready(function () {
    const table = $('#userTable').DataTable({
      responsive: true,
      autoWidth: false,
      processing: true,
      serverSide: true,
      ajax: {
        url: '{% url "ajax_user_list_data" %}',
        type: 'GET',
        dataSrc: function (json) {
          if (!json.data || json.data.length === 0) {
            $('#noUserMessage').removeClass('d-none');
            $('#userTable').hide();
          } else {
            $('#noUserMessage').addClass('d-none');
            $('#userTable').show();
          }
          return json.data;
        },
      },
      order: [[0, 'desc']],
      pageLength: 10,
      columns: [
        {
          data: 'id',
          render: function (data, type, row) {
            return `<input type="checkbox" class="user-checkbox" value="${data}">`;
          },
          orderable: false,
          searchable: false,
          className: 'text-center',
        },
        {
          data: 'SnO',
          name: 'SnO',
          searchable: false,
          className: 'text-center fw-bold',
        },
        { data: 'Username', name: 'Username', className: 'text-center' },
        { data: 'First Name', name: 'First Name', className: 'text-center' },
        {
          data: 'Email',
          name: 'Email',
          className: 'text-center text-lowercase',
        },
        {
          data: 'Role',
          name: 'Role',
          className: 'text-center text-capitalize',
        },
        {
          data: 'Actions',
          name: 'Actions',
          orderable: false,
          searchable: false,
          className: 'text-center',
        },
      ],
    });

    table.on('xhr.dt', function (e, settings, json) {
      if (json.data.length === 0) {
        $('#userTable').hide();
        $('#noUserMessage').removeClass('d-none');
      } else {
        $('#userTable').show();
        $('#noUserMessage').addClass('d-none');
      }
    });

    // Master checkbox
    $('#selectAll').click(function () {
      $('.user-checkbox').prop('checked', this.checked);
    });

    // Single delete
    $(document).on('click', '.delete_user', function (e) {
      e.preventDefault();
      const username = $(this).data('username');
      const url = $(this).attr('href');
      Swal.fire({
        title: 'Delete ' + username + '?',
        text: 'Are you sure you want to delete this user?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
      }).then(result => {
        if (result.isConfirmed) {
          window.location.href = url;
        }
      });
    });

    // Bulk delete
    $('#bulkDeleteBtn').click(function () {
      const selectedIds = $('.user-checkbox:checked')
        .map(function () {
          return $(this).val();
        })
        .get();
      if (selectedIds.length === 0) {
        Swal.fire('No users selected', '', 'info');
        return;
      }
      Swal.fire({
        title: `Delete ${selectedIds.length} selected users?`,
        text: 'This action cannot be undone!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete!',
      }).then(result => {
        if (result.isConfirmed) {
          $.ajax({
            url: '{% url "bulk_delete_users" %}',
            method: 'POST',
            data: { ids: selectedIds, csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function () {
              table.ajax.reload();
              Swal.fire('Deleted!', '', 'success');
            },
          });
        }
      });
    });
  });
</script>
{% endblock %}
