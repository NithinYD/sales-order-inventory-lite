{% extends "base.html" %} {% block content %}
<div class="row mb-3">
  <div class="col-lg-12">
    <div class="stat-card">
      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="fw-bold text-dark mb-1">Roles & Permissions</h2>
          <p class="text-muted mb-0">
            Manage user roles and their access permissions
          </p>
        </div>
        <!-- Add New Role Button -->

        <button
          class="btn btn-primary px-4"
          data-bs-toggle="modal"
          data-bs-target="#addRoleModal"
        >
          <i class="bi bi-plus-circle me-2"></i> Add New Role
        </button>
        <!-- Bulk Delete Roles Button -->
        <button id="bulkDeleteRolesBtn" class="btn btn-primary">
          <i class="bi bi-trash me-2"></i> Delete Selected
        </button>
      </div>
      <!-- Roles List Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-white py-3">
          <h5 class="card-title mb-0 fw-semibold">Current Roles</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="bg-light">
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      id="selectAll"
                      class="form-check-input"
                    />
                  </th>
                  <th>SNO</th>
                  <th class="border-0 px-4 py-3 fw-semibold">Role Name</th>
                  <th class="border-0 px-4 py-3 fw-semibold text-center">
                    Users Assigned
                  </th>
                  <th class="border-0 px-4 py-3 fw-semibold text-center">
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody>
                {% for role in roles_list %}
                <tr>
                  <td class="text-center">
                    <input
                      type="checkbox"
                      class="role-checkbox"
                      value="{{ role.id }}"
                    />
                  </td>
                  <td class="text-center">{{ forloop.counter }}</td>
                  <td class="px-4 py-3">
                    <div class="d-flex align-items-center">
                      <strong>{{ role.name }}</strong>
                    </div>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <span class="badge bg-primary rounded-pill"
                      >{{ role.user_count | default:0 }} Users</span
                    >
                  </td>
                  <td class="px-4 py-3 text-center">
                    <a
                      class="btn btn-sm btn-outline-primary me-1"
                      href="{% url 'edit_role' role.id %}"
                      role="button"
                    >
                      <i class="bi bi-pencil"></i>
                    </a>
                    <a
                      class="btn btn-sm btn-outline-secondary delete_role"
                      href="{% url 'delete_role' role.id %}"
                      data-name="{{ role.name }}"
                      role="button"
                      ><i class="bi bi-trash"></i
                    ></a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <!-- Add New Role Modal -->
    <div class="modal fade" id="addRoleModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title fw-bold">Add New Role</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <form method="post">
              {% csrf_token %} {% for field in form %}
              <div class="col-md-6">
                <label for="{{ field.id_for_label }}" class="form-label"
                  >{{ field.label }}</label
                >
                {{ field }} {% if field.help_text %}
                <small class="text-muted">{{ field.help_text }}</small>
                {% endif %} {% for error in field.errors %}
                <div class="text-danger">{{ error }}</div>
                {% endfor %}
              </div>
              {% endfor %}
              <div class="col-md-12">
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
          </div>

          <!-- Modal Footer -->
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block script %}
<script>
  document.querySelectorAll('.delete_role').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault(); // stop default delete link
      const url = this.getAttribute('href');
      const roleName = this.getAttribute('data-name') || 'this role';

      Swal.fire({
        title: `Delete ${roleName}?`,
        text: 'Are you sure you want to delete this role?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel',
      }).then(result => {
        if (result.isConfirmed) {
          window.location.href = url; // redirect if confirmed
        }
      });
    });
  });
  // Master checkbox
  $('#selectAll').click(function () {
    $('.role-checkbox').prop('checked', this.checked);
  });

  // Bulk delete
  $('#bulkDeleteRolesBtn').click(function (e) {
    e.preventDefault();
    const selectedIds = $('.role-checkbox:checked')
      .map(function () {
        return $(this).val();
      })
      .get();
    if (selectedIds.length === 0) {
      Swal.fire('No roles selected', '', 'info');
      return;
    }

    Swal.fire({
      title: `Delete ${selectedIds.length} selected roles?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Yes, delete!',
    }).then(result => {
      if (result.isConfirmed) {
        $.ajax({
          url: '{% url "bulk_group_delete" %}', // backend URL
          method: 'POST',
          data: { ids: selectedIds, csrfmiddlewaretoken: '{{ csrf_token }}' },
          success: function () {
            location.reload(); // ya table.ajax.reload() agar DataTable use ho
            Swal.fire('Deleted!', '', 'success');
          },
        });
      }
    });
  });
</script>
{% endblock %}
