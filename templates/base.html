{% load static %} {% load notification_tags %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}Dashboard | IMS {% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Style CSS -->
    <link href='{% static "css/style.css" %}' rel="stylesheet" />
    <!-- Datatables CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.3.4/css/dataTables.dataTables.min.css"
    />

    <style></style>
  </head>
  <body>
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobileOverlay"></div>

    <!-- Sidebar -->
    <nav class="sidebar" id="sidebar">
      <a href='{% url "dashboard" %}' class="brand-logo">
        <i class="bi bi-shop"></i>
        <span style="font-size: x-small">Inventory Management System (IMS)</span>
      </a>

      <ul class="nav flex-column">
        <a
          href='{% url "dashboard" %}'
          class="nav-link {% if request.resolver_match.url_name == 'dashboard' %}active{% endif %}"
        >
          <i class="bi bi-speedometer2"></i>
          <span>Overview</span>
        </a>
        <!-- Admin -->
        <li class="nav-header">
          <span>Admin</span>
        </li>
        <!-- Users & Roles -->
        {% if can_view_user or can_add_user or can_view_userrole %}
        <li class="nav-item">
          <a
            href="#users-roles"
            class="nav-link {% if '/dashboard/user_role_and_permission/' in request.path or '/dashboard/user/' in request.path %}active{% endif %}"
          >
            <i class="bi bi-person-gear"></i>
            <span>Users & Roles</span>
          </a>

          <ul
            class="nav-submenu {% if '/dashboard/user_role_and_permission/' in request.path or '/dashboard/user/' in request.path %}show{% endif %}"
          >
            {% if can_view_user %}
            <li>
              <a
                href="{% url 'all_user' %}"
                class="nav-link-sub {% if request.resolver_match.url_name == 'all_user' %}active{% endif %}"
              >
                All Users
              </a>
            </li>
            {% endif %} {% if can_add_user %}
            <li>
              <a
                href="{% url 'add_user' %}"
                class="nav-link-sub {% if request.resolver_match.url_name == 'add_user' %}active{% endif %}"
              >
                Add User
              </a>
            </li>
            {% endif %} {% if can_view_userrole %}
            <li>
              <a
                href="{% url 'user_role_and_permission' %}"
                class="nav-link-sub {% if request.resolver_match.url_name == 'user_role_and_permission' %}active{% endif %}"
              >
                Roles & Permissions
              </a>
            </li>
            {% endif %}
          </ul>
        </li>
        {% endif %}
        <!-- Inventory -->
        {% if can_view_product or can_view_category or can_add_product %}
        <li class="nav-item">
          <a
            href="#"
            class="nav-link {% if 'dashboard/inventory/product/' in request.path %}active{% endif %}"
          >
            <i class="bi bi-box"></i>
            <span>Inventory</span>
          </a>
          <ul
            class="nav-submenu {% if 'dashboard/inventory/product/' in request.path %}show{% endif %}"
          >
            {% if can_view_product %}
            <li>
              <a
                href="{% url 'product_list' %}"
                class="nav-link-sub {% if request.resolver_match.url_name == 'product_list' %}active{% endif %}"
                >Product List</a
              >
            </li>
            {% endif %}<b
            ></b>
            {% if can_add_product %}
            <li>
              <a
                href=" {% url 'add_product' %}"
                class="nav-link-sub {% if request.resolver_match.url_name == 'add_product' %}active{% endif %}"
                >Add Product</a
              >
            </li>
            {% endif %}<b
            ></b>
            {% if can_view_category %}
            <li>
              <a
                href='{% url "all_category" %}'
                class="nav-link-sub {% if request.resolver_match.url_name == 'all_category' %}active{% endif %}"
                >Category & Subcategory</a
              >
            </li>
            {% endif %}
          </ul>
        </li>
        {% endif %}
        <!-- Sales  -->
        <li class="nav-item">
          <a href="#sales" class="nav-link">
            <i class="bi bi-receipt"></i>
            <span>Sales </span>
          </a>
          <ul class="nav-submenu">
            <li>
              <a href="sales.html" class="nav-link-sub">New Sale / POS</a>
            </li>
            <li>
              <a href="sales_list.html" class="nav-link-sub">Sales List</a>
            </li>
            <li>
              <a href="returns_refunds.html" class="nav-link-sub"
                >Returns & Refunds</a
              >
            </li>
            <li>
              <a href="customer_orders.html" class="nav-link-sub"
                >Customer Orders</a
              >
            </li>
          </ul>
        </li>
        <!-- Purchases  -->
        <li class="nav-item">
          <a href="#purchases" class="nav-link">
            <i class="bi bi-cart-plus"></i>
            <span>Purchases </span>
          </a>
          <ul class="nav-submenu">
            <li>
              <a href="purchase_order.html" class="nav-link-sub"
                >New Purchase Order</a
              >
            </li>
            <li>
              <a href="purchase_list.html" class="nav-link-sub"
                >Purchase List</a
              >
            </li>
            <li>
              <a href="supplier_invoice.html" class="nav-link-sub"
                >Supplier Invoices</a
              >
            </li>
            <li>
              <a href="goods_received_notes.html" class="nav-link-sub"
                >Goods Received Notes</a
              >
            </li>
          </ul>
        </li>
        <!-- Suppliers  -->
        {% if can_view_supplier or can_add_supplier or can_edit_supplier %}
        <li class="nav-item">
          <a
            href="#suppliers"
            class="nav-link {% if '/dashboard/inventory/supplier/' in request.path %}active{% endif %}"
          >
            <i class="bi bi-truck"></i>
            <span>Suppliers </span>
          </a>
          <ul
            class="nav-submenu {% if '/dashboard/inventory/supplier/' in request.path %}show{% endif %}"
          >
            {% if can_view_supplier %}
            <li>
              <a
                href='{% url "all_supplier" %}'
                class="nav-link-sub {% if request.resolver_match.url_name == 'all_supplier' %}active{% endif %}"
                >All Suppliers</a
              >
            </li>
            {% endif %}
            <b></b
            >{% if can_add_supplier%}
            <li>
              <a
                href='{% url "add_supplier" %}'
                class="nav-link-sub {% if request.resolver_match.url_name == 'add_supplier' %}active{% endif %}"
                >Add Supplier</a
              >
            </li>
            {% endif %}
            <b></b>
            {% if can_view_supplier_ledger %}
            <li>
              <a
                href='{% url "supplier_ledger" %}'
                class="nav-link-sub {% if request.resolver_match.url_name == 'supplier_ledger' %}active{% endif %}"
                >Supplier Ledger</a
              >
            </li>
            {% endif %}
          </ul>
        </li>
        {% endif %}
        <!-- Warehouse  -->
        {% if can_view_warehouse or can_add_warehouse or can_edit_warehouse %}
        <li class="nav-item">
          <a
            href="#Warehouse"
            class="nav-link {% if '/dashboard/inventory/warehouse/' in request.path %}active{% endif %}"
          >
            <i class="bi bi-building"></i>
            <span>Warehouse </span>
          </a>
          <ul
            class="nav-submenu {% if '/dashboard/inventory/warehouse/' in request.path %}show{% endif %}"
          >
            {% if can_add_warehouse or can_edit_warehouse%}
            <li>
              <a
                href='{% url "warehouse" %}'
                class="nav-link-sub {% if request.resolver_match.url_name == 'warehouse' %}active{% endif %}"
                >Warehouse</a
              >
            </li>
            {% endif %} {% if can_view_warehouse %}
            <li>
              <a
                href='{% url "warehouse_list" %}'
                class="nav-link-sub {% if request.resolver_match.url_name == 'warehouse_list' %}active{% endif %}"
                >Warehouse List</a
              >
            </li>
            {% endif %}
          </ul>
        </li>
        {% endif %}
        <!-- Customers  -->
        <li class="nav-item">
          <a href="#customers" class="nav-link">
            <i class="bi bi-people"></i>
            <span>Customers </span>
          </a>
          <ul class="nav-submenu">
            <li>
              <a href="all_customers.html" class="nav-link-sub"
                >All Customers</a
              >
            </li>
            <li>
              <a href="add_customer.html" class="nav-link-sub">Add Customer</a>
            </li>
            <li>
              <a href="customer_ledger.html" class="nav-link-sub"
                >Customer Ledger</a
              >
            </li>
          </ul>
        </li>
        <!-- Reports  -->
        <li class="nav-item">
          <a href="#reports" class="nav-link">
            <i class="bi bi-graph-up"></i>
            <span>Reports </span>
          </a>
          <ul class="nav-submenu">
            <li>
              <a href="sales_report.html" class="nav-link-sub"
                >Sales Report (daily, monthly, custom)</a
              >
            </li>
            <li>
              <a href="purchase_report.html" class="nav-link-sub"
                >Purchase Report</a
              >
            </li>
            <li>
              <a href="stock_report.html" class="nav-link-sub">Stock Report</a>
            </li>
            <li>
              <a href="profit_loss_report.html" class="nav-link-sub"
                >Profit & Loss Report</a
              >
            </li>
            <li>
              <a href="tax_report.html" class="nav-link-sub">Tax Report</a>
            </li>
          </ul>
        </li>

        <!-- Settings -->
        <li class="nav-item">
          <a href="#settings" class="nav-link">
            <i class="bi bi-gear"></i>
            <span>Settings</span>
          </a>
          <ul class="nav-submenu">
            <li>
              <a href="company_profile.html" class="nav-link-sub"
                >Company Profile</a
              >
            </li>
            <li>
              <a href="tax_currency.html" class="nav-link-sub"
                >Tax & Currency Settings</a
              >
            </li>
            <li>
              <a href="payment_methods.html" class="nav-link-sub"
                >Payment Methods</a
              >
            </li>
            <li>
              <a href="notification_settings.html" class="nav-link-sub"
                >Notification Settings</a
              >
            </li>
            <li>
              <a href="backup_restore.html" class="nav-link-sub"
                >Backup & Restore</a
              >
            </li>
          </ul>
        </li>
        <!-- Supervisor -->
        <li class="nav-header">
          <span>Supervisor</span>
        </li>
        <!-- Cashier -->
        <li class="nav-header">
          <span>Cashier</span>
        </li>
        <!-- Stock Handler -->
        <li class="nav-header">
          <span>Stock Handler</span>
        </li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
      <!-- Top Navigation -->
      <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
          <button class="btn btn-outline-primary me-3" id="sidebarToggle">
            <i class="bi bi-list"></i>
          </button>

          <h4 class="mb-0 text-dark" id="pageTitle">Dashboard Overview</h4>

          <div class="ms-auto d-flex align-items-center">
            <!-- Notification Dropdown -->
            {% get_user_notifications request.user as notifications %}

            <div class="dropdown" style="margin-right: 20px">
              <!-- Notification Bell -->
              <button
                class="btn btn-light position-relative border-0 shadow-sm rounded-circle p-2"
                type="button"
                id="notificationDropdown"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                <i class="bi bi-bell-fill fs-5 text-primary"></i>
                {% if notifications %}
                <span
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger shadow-sm"
                  style="font-size: 0.65rem"
                >
                  {{ notifications|length }}
                  <span class="visually-hidden">new notifications</span>
                </span>
                {% endif %}
              </button>

              <!-- Notification Dropdown Menu -->
              <ul
                class="dropdown-menu dropdown-menu-end border-0 shadow-lg p-0"
                aria-labelledby="notificationDropdown"
                style="
                  width: 360px;
                  max-height: 420px;
                  overflow-y: auto;
                  border-radius: 0.75rem;
                "
              >
                <li class="p-3 border-bottom bg-light fw-semibold text-primary">
                  Notifications {% if notifications %}
                  <span class="badge bg-secondary ms-2"
                    >{{ notifications|length }}</span
                  >
                  {% endif %}
                </li>

                {% if notifications %} {% for n in notifications %}
                <li>
                  <a
                    href="{% url 'notification_redirect_view' n.id %}"
                    class="dropdown-item py-3 px-3 d-block border-bottom {% if not n.is_read %}bg-light fw-bold{% else %}bg-info{% endif %} text-dark text-decoration-none notification-item"
                  >
                    <div class="d-flex align-items-start">
                      <div class="flex-grow-1">
                        <div class="small lh-sm">{{ n.message|safe }}</div>
                        <small class="text-muted d-block mt-1">
                          <i class="bi bi-clock me-1"></i>
                          {{n.created_at|date:"d M Y, H:i" }}
                        </small>
                      </div>
                      {% if not n.is_read %}
                      <span
                        class="badge bg-primary rounded-circle ms-2"
                        style="width: 8px; height: 8px"
                      ></span>
                      {% endif %}
                    </div>
                  </a>
                </li>
                {% endfor %} {% else %}
                <li class="dropdown-item text-center py-4 text-muted">
                  <i class="bi bi-inbox fs-4 d-block mb-2"></i>
                  No notifications
                </li>
                {% endif %}
              </ul>
            </div>

            <div class="dropdown">
              <button
                class="btn btn-outline-secondary dropdown-toggle"
                type="button"
                data-bs-toggle="dropdown"
              >
                <img
                  src="https://images.pexels.com/photos/1239291/pexels-photo-1239291.jpeg"
                  alt="Profile"
                  class="profile-avatar-sm me-2"
                />
                <span class="ms-2 d-none d-sm-inline">Admin</span>
              </button>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-person"></i> Profile</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#"
                    ><i class="bi bi-gear"></i> Settings</a
                  >
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="{% url 'logout' %}"
                    ><i class="bi bi-box-arrow-right"></i> Logout</a
                  >
                </li>
              </ul>
            </div>
          </div>
        </div>
      </nav>

      <!-- Dashboard Content -->
      <div class="container-fluid p-4">
        <!-- Django Messages -->
        {% comment %} {% if messages %} {% for message in messages %}
        <div
          class="alert alert-{{ message.tags }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %} {% endif %} {% endcomment %}
        <!-- End of Django Messages -->
        <!-- Form Messages -->
        {% comment %} {% if form.errors %}
        <div
          class="alert alert-danger alert-dismissible fade show"
          role="alert"
        >
          <strong>Error!</strong> Please correct the following error(s):
          <ul>
            {% for field in form %} {% if field.errors %}
            <li>{{ field.label }}: {{ field.errors.as_text }}</li>
            {% endif %} {% endfor %}
          </ul>
        </div>
        {% endif %} {% endcomment %}
        <!-- End of Form Messages -->

        <div id="contentArea">{% block content %}{% endblock %}</div>
      </div>
    </div>

    <!-- Main JS -->
    <script src="{% static 'js/main.js'%}"></script>
    <!-- JQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- Sweet Alert 2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <!-- DataTables Bootstrap Integration (optional but recommended) -->
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

    <!-- Bootstrap JS (after DataTables) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block script %}{% endblock %}
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Collect all Django messages
        const djangoMessages = [
          {% for message in messages %}
            {
              text: "{{ message|escapejs }}",
              type: "{% if 'error' in message.tags %}error{% elif 'success' in message.tags %}success{% elif 'warning' in message.tags %}warning{% else %}info{% endif %}"
            }{% if not forloop.last %},{% endif %}
          {% endfor %}
        ];

        // Show each message as a modal with OK button
        djangoMessages.forEach((msg, index) => {
          setTimeout(() => {
            Swal.fire({
              icon: msg.type,
              title: msg.text,
              showConfirmButton: true,     // OK button
              confirmButtonText: 'OK',     // Custom text
              allowOutsideClick: false,    // prevent click outside to close
              allowEscapeKey: true,        // allow ESC to close
              background: '#ffffff',
              iconColor: msg.type === 'error' ? '#dc3545' : (msg.type === 'success' ? '#28a745' : '#ffc107'),
              customClass: {
                popup: 'shadow-sm border rounded p-3'
              }
            });
          }, index * 500); // stagger multiple messages by 0.5s
        });
      });
    </script>
  </body>
</html>
