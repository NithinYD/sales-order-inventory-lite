{% extends "base.html" %} {% block title %} All Supplier {% endblock %}<br />
{% block content %}
<div class="row mb-3">
  <div class="col-lg-12">
    <div class="stat-card">
      <!-- Header Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <div class="row align-items-center">
                <!-- Title + Description -->
                <div class="col-md-6">
                  <h1 class="h3 mb-1 fw-bold text-dark">
                    <i class="bi bi-truck text-primary me-2"></i>
                    Supplier Management
                  </h1>
                  <p class="text-muted mb-0">
                    Manage your supplier relationships and track outstanding
                    balances
                  </p>
                </div>

                <!-- Buttons vertically aligned -->
                <div
                  class="col-md-6 text-md-end mt-3 mt-md-0 d-flex flex-column align-items-md-end"
                >
                  <a
                    href="{% url 'add_supplier' %}"
                    class="btn btn-success btn-sm shadow-sm mb-2 d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-plus-circle me-2"></i>
                    Add New Supplier
                  </a>

                  <button
                    id="bulkDeleteBtn"
                    class="btn btn-danger btn-sm shadow-sm d-flex align-items-center justify-content-center"
                  >
                    <i class="bi bi-trash me-1"></i>
                    Delete Selected
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title text-muted small">Total Suppliers</h5>
                  <h3 class="mb-0">248</h3>
                </div>
                <div class="bg-primary bg-opacity-10 p-3 rounded">
                  <i class="bi bi-people fs-4 text-primary"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title text-muted small">Active Suppliers</h5>
                  <h3 class="mb-0">217</h3>
                </div>
                <div class="bg-success bg-opacity-10 p-3 rounded">
                  <i class="bi bi-check-circle fs-4 text-success"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title text-muted small">Total Balance</h5>
                  <h3 class="mb-0">$184,650</h3>
                </div>
                <div class="bg-info bg-opacity-10 p-3 rounded">
                  <i class="bi bi-currency-dollar fs-4 text-info"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <div>
                  <h5 class="card-title text-muted small">Overdue</h5>
                  <h3 class="mb-0">$24,800</h3>
                </div>
                <div class="bg-danger bg-opacity-10 p-3 rounded">
                  <i class="bi bi-exclamation-triangle fs-4 text-danger"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Table -->
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table" id="supplierTable">
              <thead>
                <tr>
                  <th>
                    <input
                      type="checkbox"
                      id="selectAll"
                      class="form-check-input"
                    />
                  </th>
                  <th>Sno</th>
                  <th>Supplier Name</th>
                  <th>Contact Person</th>
                  <th>Phone Number</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <!-- No Supplier Message -->
          <div id="noSupplierMessage" class="text-center py-5 my-4 d-none">
            <h5 class="fw-bold text-secondary mb-2">
              <i class="fa-solid fa-user-slash text-danger me-2"></i>No Supplier
              Found
            </h5>
            <p class="text-muted mb-3">You haven't added any Supplier yet!</p>
            <a
              href='{% url "add_supplier" %}'
              type="button"
              class="btn btn-success btn-sm shadow-sm"
            >
              <i class="bi bi-plus-circle me-2"></i>
              Add New Supplier
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% block script %}
<script>
  $(document).ready(function () {
    const table = $('#supplierTable').DataTable({
      responsive: false,
      autoWidth: false,
      processing: true,
      serverSide: true,
      ajax: {
        url: "{% url 'ajax_supplier_list_data' %}",
        type: 'GET',
        dataSrc: function (json) {
          if (!json.data || json.data.length === 0) {
            $('#noSupplierMessage').removeClass('d-none');
            $('#supplierTable').hide();
          } else {
            $('#noSupplierMessage').addClass('d-none');
            $('#supplierTable').show();
          }
          return json.data;
        },
      },
      order: [[0, 'desc']],
      pageLength: 10,
      lengthMenu: [5, 10, 5000, 1000, 500],
      columns: [
        {
          data: 'id',
          render: function (data, type, row) {
            return `<input type="checkbox" class="supplier-checkbox" value="${data}">`;
          },
          orderable: false,
          searchable: false,
          className: 'text-center',
        },
        { data: 'sno', name: 'sno', className: 'text-center fw-bold' },
        {
          data: 'supplier_name',
          name: 'supplier_name',
          className: 'text-center',
        },
        {
          data: 'contact_person',
          name: 'contact_person',
          className: 'text-center',
        },
        {
          data: 'phone_number',
          name: 'phone_number',
          className: 'text-center',
        },
        {
          data: 'email',
          name: 'email',
          className: 'text-center text-lowercase',
        },
        { data: 'status', name: 'status', className: 'text-center' },
        {
          data: 'action',
          name: 'action',
          orderable: false,
          searchable: false,
          className: 'text-center',
        },
      ],
    });
    // Master checkbox
    $('#selectAll').click(function () {
      $('.supplier-checkbox').prop('checked', this.checked);
    });
    // Delete Supplier Confirmation
    $(document).on('click', '.delete_supplier', function (e) {
      e.preventDefault();
      const supplier_name = $(this).data('supplier-name');
      const url = $(this).attr('href');

      Swal.fire({
        title: 'Delete ' + supplier_name + '?',
        text: 'Are you sure you want to delete this supplier?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
      }).then(result => {
        if (result.isConfirmed) {
          window.location.href = url;
        }
      });
    });
    // Bulk delete
    $('#bulkDeleteBtn').click(function () {
      const selectedIds = $('.supplier-checkbox:checked')
        .map(function () {
          return $(this).val();
        })
        .get();
      if (selectedIds.length === 0) {
        Swal.fire('No suppliers selected', '', 'info');
        return;
      }
      Swal.fire({
        title: `Delete ${selectedIds.length} selected Suppliers?`,
        text: 'This action cannot be undone!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete!',
      }).then(result => {
        if (result.isConfirmed) {
          $.ajax({
            url: '{% url "bulk_delete_suppliers" %}',
            method: 'POST',
            data: { ids: selectedIds, csrfmiddlewaretoken: '{{ csrf_token }}' },
            success: function () {
              table.ajax.reload();
              if (response.status === 'partial') {
                Swal.fire('Partial Delete', response.message, 'info');
              } else {
                Swal.fire('Deleted!', '', 'success');
              }
            },
            error: function (error) {
              const msg =
                error.responseJSON?.message ||
                error.responseJSON?.status ||
                'Unknown error';
              Swal.fire('Error', msg, 'error');
            },
          });
        }
      });
    });
  });
</script>
{% endblock %} {% endblock %}
